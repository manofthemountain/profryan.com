---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

function postUrlFromId(id: string) {
	// id looks like: "some-post.md" or "folder/some-post.md"
	const noExt = id.replace(/\.(md|mdx)$/i, '');
	const slug = noExt.split('/').pop() ?? noExt;
	return `/blog/${slug}/`;
}

function heroSrc(hero: unknown): string | null {
	// Supports either:
	// - string paths ("/images/...") if you ever change schema
	// - ImageMetadata-ish objects with .src (what your schema currently reports)
	if (!hero) return null;
	if (typeof hero === 'string') return hero;

	if (typeof hero === 'object' && hero !== null && 'src' in hero) {
		return (hero as { src: string }).src;
	}

	return null;
}

function readingTime(body?: string) {
	const text = body ?? '';
	const words = text.trim() ? text.trim().split(/\s+/).length : 0;
	return Math.max(1, Math.ceil(words / 220));
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={`Blog | ${SITE_TITLE}`}
			description="Cybersecurity writeups, technical breakdowns, and practical notes."
		/>
	</head>

	<body>
		<Header />

		<main>
			<header class="page-header">
				<h1>Blog</h1>
				<p class="lede">
					Technical breakdowns and practical cybersecurity notes — written for people who ship.
				</p>
			</header>

			<section class="grid" aria-label="Blog posts">
				{posts.map((post) => {
					const href = postUrlFromId(post.id);
					const img = heroSrc(post.data.heroImage);
					const minutes = readingTime(post.body);

					return (
						<article class="card">
							<a class="card-link" href={href} aria-label={`Read: ${post.data.title}`}>
								<div class="media">
									{img ? (
										<img
											src={img}
											alt={post.data.title}
											loading="lazy"
											decoding="async"
											width="720"
											height="360"
										/>
									) : (
										<div class="placeholder" aria-hidden="true" />
									)}
								</div>

								<div class="content">
									<p class="meta">
										<FormattedDate date={post.data.pubDate} />
										<span class="dot" aria-hidden="true">•</span>
										<span>{minutes} min read</span>
									</p>

									<h2 class="title">{post.data.title}</h2>
									<p class="desc">{post.data.description}</p>
								</div>
							</a>
						</article>
					);
				})}
			</section>
		</main>

		<Footer />
	</body>
</html>

<style>
	.page-header {
		margin: 0 0 1.5rem 0;
	}

	.lede {
		margin: 0.35rem 0 0 0;
		max-width: 70ch;
		opacity: 0.85;
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(12, 1fr);
		gap: 1rem;
	}

	.card {
		grid-column: span 12;
		border: 1px solid rgba(var(--border), 1);
		border-radius: var(--radius-lg);
		background: rgba(var(--surface), 1);
		box-shadow: var(--shadow-sm);
		overflow: hidden;
		transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
	}

	.card:hover {
		transform: translateY(-2px);
		box-shadow: var(--shadow-md);
		border-color: rgba(var(--border), 0.9);
	}

	.card-link {
		display: block;
		color: inherit;
		text-decoration: none;
	}

	.media {
		width: 100%;
		aspect-ratio: 2 / 1;
		background: rgba(var(--surface-2), 1);
		overflow: hidden;
	}

	.media img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		border-radius: 0;
	}

	.placeholder {
		width: 100%;
		height: 100%;
		background: linear-gradient(135deg, rgba(var(--surface-2), 1), rgba(var(--surface), 1));
	}

	.content {
		padding: 1rem 1rem 1.15rem 1rem;
	}

	.meta {
		margin: 0 0 0.4rem 0;
		display: flex;
		gap: 0.5rem;
		align-items: center;
		font-size: 0.92rem;
		color: rgba(var(--text-muted), 1);
	}

	.dot {
		opacity: 0.7;
	}

	.title {
		margin: 0 0 0.35rem 0;
		font-size: 1.35rem;
		line-height: 1.2;
	}

	.desc {
		margin: 0;
		opacity: 0.9;
	}

	@media (min-width: 860px) {
		.card {
			grid-column: span 6;
		}
	}
</style>