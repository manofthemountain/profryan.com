---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog'))
	.filter((p) => !p.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

function readingTimeFromBody(body: string) {
	const wordsPerMinute = 225;
	const words = body.trim().split(/\s+/).filter(Boolean).length;
	return Math.max(1, Math.round(words / wordsPerMinute));
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={`Blog | ${SITE_TITLE}`}
			description="Articles and technical breakdowns on practical cybersecurity."
		/>
	</head>

	<body>
		<Header />

		<main>
			<header class="page-header">
				<h1>Blog</h1>
				<p class="page-subtitle">Technical breakdowns and practical cybersecurity notes.</p>
			</header>

			<section class="posts" aria-label="Blog posts">
				{posts.map((post) => {
					const rt = readingTimeFromBody(post.body);
					const hero = post.data.heroImage; // string (public path) or possibly ImageMetadata in the future

					return (
						<article class="card">
							<a class="card-link" href={`/blog/${post.slug}/`} aria-label={`Read: ${post.data.title}`}>
								<div class="media">
									{typeof hero === 'string' && hero.length > 0 ? (
										<img
											src={hero}
											alt={post.data.heroImageAlt ?? post.data.title}
											width="720"
											height="360"
											loading="lazy"
											decoding="async"
										/>
									) : (
										<div class="media-fallback" aria-hidden="true" />
									)}
								</div>

								<div class="content">
									<h2 class="title">{post.data.title}</h2>

									<p class="meta">
										<FormattedDate date={post.data.pubDate} />
										<span class="dot" aria-hidden="true">â€¢</span>
										<span>{rt} min read</span>
									</p>

									<p class="desc">{post.data.description}</p>

									{Array.isArray(post.data.tags) && post.data.tags.length > 0 && (
										<ul class="tags" aria-label="Tags">
											{post.data.tags.slice(0, 6).map((tag) => (
												<li class="tag">{tag}</li>
											))}
										</ul>
									)}
								</div>
							</a>
						</article>
					);
				})}
			</section>
		</main>

		<Footer />
	</body>
</html>

<style>
	.page-header {
		margin: 0 0 2rem 0;
	}

	.page-subtitle {
		margin: 0.25rem 0 0 0;
		color: rgba(var(--text-muted), 1);
		max-width: 60ch;
	}

	.posts {
		display: grid;
		grid-template-columns: 1fr;
		gap: 1.25rem;
	}

	.card {
		border: 1px solid rgba(var(--border), 1);
		border-radius: var(--radius-lg);
		background: rgba(var(--surface), 1);
		box-shadow: var(--shadow-sm);
		overflow: hidden;
	}

	.card-link {
		display: grid;
		grid-template-columns: 240px 1fr;
		gap: 0;
		color: inherit;
		text-decoration: none;
	}

	.media {
		position: relative;
		background: rgba(var(--surface-2), 1);
	}

	.media img {
		display: block;
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	/* Placeholder block when a post has no hero image */
	.media-fallback {
		width: 100%;
		height: 100%;
		min-height: 160px;
		background:
			linear-gradient(135deg, rgba(var(--gray-light), 0.55), rgba(var(--surface-2), 1));
	}

	.content {
		padding: 1.1rem 1.15rem;
	}

	.title {
		margin: 0 0 0.5rem 0;
		font-size: 1.25rem;
		line-height: 1.2;
	}

	.meta {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin: 0 0 0.75rem 0;
		font-size: 0.95rem;
		color: rgba(var(--text-muted), 1);
	}

	.dot {
		opacity: 0.6;
	}

	.desc {
		margin: 0 0 0.9rem 0;
		color: rgba(var(--text), 1);
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.tag {
		font-size: 0.85rem;
		padding: 0.25rem 0.55rem;
		border-radius: 999px;
		border: 1px solid rgba(var(--border), 1);
		background: rgba(var(--surface-2), 1);
		color: rgba(var(--text-muted), 1);
	}

	/* Hover polish */
	.card-link:hover .title {
		color: var(--accent);
	}
	.card-link:focus-visible {
		outline: 3px solid rgba(var(--ring), var(--ring-alpha));
		outline-offset: 4px;
		border-radius: var(--radius-lg);
	}

	/* Responsive */
	@media (max-width: 820px) {
		.card-link {
			grid-template-columns: 1fr;
		}
		.media-fallback {
			min-height: 180px;
		}
	}

	@media (max-width: 420px) {
		.content {
			padding: 1rem;
		}
	}
</style>