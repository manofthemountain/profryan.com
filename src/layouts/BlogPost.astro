---
import type { ImageMetadata } from 'astro';
import type { CollectionEntry } from 'astro:content';

import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = {
	entry: CollectionEntry<'blog'>;
};

const { entry } = Astro.props;
const { Content } = await entry.render();

const { title, description, pubDate, heroImage, heroImageAlt } = entry.data;

/* -----------------------------
   Reading Time Calculation
--------------------------------*/
function calculateReadingTime(text: string) {
	const wordsPerMinute = 225;
	const words = text.trim().split(/\s+/).filter(Boolean).length;
	return Math.max(1, Math.round(words / wordsPerMinute));
}

const readingTime = calculateReadingTime(entry.body);

/* -----------------------------
   Hero image handling:
   Supports either:
   - string paths like "/images/..." (from public/)
   - ImageMetadata objects (imported assets / MDX)
--------------------------------*/
const isImageMetadata = (v: unknown): v is ImageMetadata => {
	return !!v && typeof v === 'object' && 'src' in v;
};

const hero = heroImage as unknown;
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage as any} />
	</head>

	<body>
		<Header />

		<main>
			<article class="post">
				<header class="post-header">
					<h1 class="post-title">{title}</h1>

					<div class="post-meta">
						<span><FormattedDate date={pubDate} /></span>
						<span class="meta-divider">â€¢</span>
						<span>{readingTime} min read</span>
					</div>
				</header>

				{hero && (
					<figure class="post-hero">
						{typeof hero === 'string' ? (
							<img src={hero} alt={heroImageAlt || title} loading="eager" />
						) : isImageMetadata(hero) ? (
							<img
								src={hero.src}
								alt={heroImageAlt || title}
								width={hero.width}
								height={hero.height}
								loading="eager"
							/>
						) : null}
					</figure>
				)}

				<section class="post-content prose">
					<Content />
				</section>
			</article>
		</main>

		<Footer />
	</body>
</html>

<style>
	.post {
		max-width: 760px;
		margin: 0 auto;
	}

	.post-header {
		margin-bottom: 2rem;
	}

	.post-title {
		margin-bottom: 0.75rem;
		line-height: 1.15;
	}

	.post-meta {
		display: flex;
		align-items: center;
		gap: 0.6rem;
		font-size: 0.95rem;
		color: rgba(var(--text-muted), 1);
	}

	.meta-divider {
		opacity: 0.5;
	}

	.post-hero {
		margin: 2rem 0 2.5rem 0;
	}

	.post-hero img {
		width: 100%;
		height: auto;
		border-radius: var(--radius-lg);
		box-shadow: var(--shadow-md);
	}

	.post-content {
		font-size: 1rem;
	}

	.post-content h2 {
		margin-top: 2.4rem;
	}

	.post-content h3 {
		margin-top: 2rem;
	}

	.post-content h4 {
		margin-top: 1.6rem;
	}

	.post-content pre {
		margin: 1.8rem 0;
	}

	@media (max-width: 720px) {
		.post-meta {
			flex-wrap: wrap;
			gap: 0.4rem;
		}
	}
</style>